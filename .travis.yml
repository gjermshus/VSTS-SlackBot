sudo: required
language: node_js
node_js:
  - "8"
services:
  - docker
env:
  global:
    - COMMIT=${TRAVIS_COMMIT::8}
install:
  - npm install gulp-cli gulp gulp-clean gulp-util
  - npm install
script:
  - echo $TRAVIS_BRANCH
  - node_modules/.bin/gulp --production
  - docker login -u $DOCKER_USR -p $DOCKER_PASS
  - export VERSION=$(cat package.json | grep version | head -1 | sed 's/[version:,\",]//g' | tr -d '[[:space:]]')
  - export REPO=gjermshus/vsts-slackbot
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH ; fi`
  - echo "Tag:" $TAG
  - echo "Commit:" $COMMIT
  - echo "Repo:" $REPO
  - echo "Version:" $VERSION
  - docker build -f Dockerfile -t $REPO:$COMMIT .
  - docker tag $REPO:$COMMIT $REPO:$TAG
  - docker tag $REPO:$COMMIT $REPO:travis-$TRAVIS_BUILD_NUMBER
  - if [ "$TRAVIS_BRANCH" == "master" ]; then docker tag $REPO:$COMMIT $REPO:$VERSION
  - if [ "$TRAVIS_BRANCH" == "master" ]; then docker push $REPO; fi
#after_success:
  # - if [[ $TRAVIS_BRANCH == "master" ]]; then
  #     docker build -t gjermshus/vsts-slackbot:latest .
  #     docker tag gjermshus/vsts-slackbot:latest gjermshus/vsts-slackbot:${VERSION}
  #     docker login -u="$DOCKER_USR" -p="$DOCKER_PASS"
  #     docker push gjermshus/vsts-slackbot:${VERSION}
  #     docker push gjermshus/vsts-slackbot:latest;
  #   fi  